# Agency Statistics Update Process

This document explains how Agency Statistics are calculated and kept up to date.

## Overview

The Agency Stats screens read from the `agency_stats` table in Supabase.  
Those rows are generated by a Python script that calculates stats and inserts a new
record for each agency.

## Key Files

- `calculate_agency_stats.py`
  - Calculates stats for all agencies.
  - Reads bookings from `recent_bookings_with_charges`.
  - Inserts a new row into `agency_stats` for each agency.
- `setup_agency_stats_cron.sh`
  - Installs the cron job that runs the calculation script twice daily.

## Cron Schedule

The script is scheduled to run:
- **6:00 AM** daily
- **6:00 PM** daily

Cron entries created (from `zAgencyStatsUpdate`):
```
0 6 * * * cd /Users/willwalsh/PutnamApp/App/zAgencyStatsUpdate && /usr/bin/python3 /Users/willwalsh/PutnamApp/App/zAgencyStatsUpdate/calculate_agency_stats.py >> /Users/willwalsh/PutnamApp/App/logs/agency_stats_cron.log 2>&1
0 18 * * * cd /Users/willwalsh/PutnamApp/App/zAgencyStatsUpdate && /usr/bin/python3 /Users/willwalsh/PutnamApp/App/zAgencyStatsUpdate/calculate_agency_stats.py >> /Users/willwalsh/PutnamApp/App/logs/agency_stats_cron.log 2>&1
```

## Log Location

The cron job writes to:
```
/Users/willwalsh/PutnamApp/App/logs/agency_stats_cron.log
```

If the log file does not exist yet, create the logs folder and run once:
```
mkdir -p /Users/willwalsh/PutnamApp/App/logs
python3 /Users/willwalsh/PutnamApp/App/zAgencyStatsUpdate/calculate_agency_stats.py >> /Users/willwalsh/PutnamApp/App/logs/agency_stats_cron.log 2>&1
```

## Manual Run (Anytime)

Run manually to force an update:
```
cd /Users/willwalsh/PutnamApp/App/zAgencyStatsUpdate
python3 calculate_agency_stats.py
```

## Verify Cron

Check that the cron job exists:
```
crontab -l | grep calculate_agency_stats.py
```

Tail the log:
```
tail -f /Users/willwalsh/PutnamApp/App/logs/agency_stats_cron.log
```

## How the App Reads Stats

The app loads the **latest** row per agency:

- Table: `agency_stats`
- Sort order: `calculated_at DESC`
- Limit: `1`

So if the cron job runs on schedule, the app always shows the newest stats.
